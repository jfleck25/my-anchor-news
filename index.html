<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Anchor | Daily Briefing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4 { font-family: 'Merriweather', serif; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.7);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-200">
    <div id="root"></div>

    <!-- React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- Configuration ---
        const backendUrl = ""; 

        // --- Icons (Defined as React Components) ---
        const Icons = {
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        };

        // --- Component: Settings Modal (Unchanged) ---
        const SettingsModal = ({ isOpen, onClose, currentSettings, onSave }) => {
            if (!isOpen) return null;
            const [sources, setSources] = React.useState(currentSettings.sources || []);
            const [timeWindow, setTimeWindow] = React.useState(currentSettings.time_window_hours || 24);
            const [newSource, setNewSource] = React.useState("");

            const handleAddSource = () => { if (newSource && !sources.includes(newSource)) { setSources([...sources, newSource]); setNewSource(""); } };
            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddSource(); } };
            const handleRemoveSource = (sourceToRemove) => { setSources(sources.filter(s => s !== sourceToRemove)); };
            const handleSave = () => { onSave({ sources, time_window_hours: parseInt(timeWindow) }); onClose(); };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 dark:border-slate-700">
                        {/* ... Settings Content (Same as before) ... */}
                        <div className="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                            <h3 className="text-lg font-semibold text-slate-800 dark:text-white font-sans">Configuration</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><Icons.Trash /></button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Lookback Period</label>
                                <select value={timeWindow} onChange={(e) => setTimeWindow(e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg p-2.5">
                                    <option value="12">Last 12 Hours</option>
                                    <option value="24">Last 24 Hours</option>
                                    <option value="72">Last 3 Days</option>
                                    <option value="168">Last 7 Days</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Sources (Domains)</label>
                                <div className="flex gap-2 mb-3">
                                    <input type="text" value={newSource} onChange={(e) => setNewSource(e.target.value)} onKeyDown={handleKeyDown} placeholder="e.g. bloomberg.com" className="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg p-2.5" />
                                    <button onClick={handleAddSource} className="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium">Add</button>
                                </div>
                                <div className="bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 p-2 max-h-48 overflow-y-auto">
                                    {sources.map(source => (
                                        <div key={source} className="flex justify-between items-center p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800 group">
                                            <span className="text-sm font-medium text-slate-700 dark:text-slate-300">{source}</span>
                                            <button onClick={() => handleRemoveSource(source)} className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icons.Trash /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg text-sm font-medium">Cancel</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:opacity-90 rounded-lg text-sm font-medium">Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Component: Login Page ---
        const LoginPage = () => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
                <div className="z-10 w-full max-w-md p-8 text-center">
                    <div className="w-16 h-16 bg-brand-600 rounded-2xl mx-auto flex items-center justify-center shadow-2xl shadow-brand-500/30 mb-6 rotate-3">
                        <svg className="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                    </div>
                    <h1 className="text-4xl font-serif font-bold text-slate-900 dark:text-white mb-3">My Anchor</h1>
                    <p className="text-slate-500 dark:text-slate-400 text-lg mb-10">Your personalized AI news analyst.</p>
                    <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700">
                        <a href={`${backendUrl}/login`} className="flex items-center justify-center w-full py-3.5 px-4 border border-slate-300 dark:border-slate-600 rounded-xl text-slate-700 dark:text-white bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 transition-all duration-200 gap-3 font-medium">
                            Continue with Google
                        </a>
                    </div>
                </div>
            </div>
        );

        // --- Component: Loading State ---
        const LoadingState = ({ text }) => (
            <div className="flex flex-col items-center justify-center py-20 animate-pulse">
                <div className="w-16 h-16 bg-slate-200 dark:bg-slate-700 rounded-full mb-4 relative">
                    <div className="absolute inset-0 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p className="text-slate-500 dark:text-slate-400 font-medium">{text || "Processing..."}</p>
            </div>
        );

        // --- Component: Dashboard ---
        const Dashboard = ({ userInfo, sharedData }) => {
            const [analysis, setAnalysis] = React.useState(sharedData || null);
            const [audioSrc, setAudioSrc] = React.useState(null);
            const [isFetching, setIsFetching] = React.useState(false);
            const [isGeneratingAudio, setIsGeneratingAudio] = React.useState(false);
            const [isSharing, setIsSharing] = React.useState(false);
            const [shareUrl, setShareUrl] = React.useState(null);
            const [error, setError] = React.useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);
            const [settings, setSettings] = React.useState({});
            const [darkMode, setDarkMode] = React.useState(false);

            React.useEffect(() => {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) setDarkMode(true);
            }, []);

            React.useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            React.useEffect(() => {
                if (!sharedData) { // Only fetch settings if not in shared mode
                    const fetchSettings = async () => {
                        try {
                            const res = await fetch(`${backendUrl}/api/settings`, { credentials: 'include' });
                            if (res.ok) setSettings(await res.json());
                        } catch (e) { console.error("Settings fetch error:", e); }
                    };
                    fetchSettings();
                }
            }, [sharedData]);

            const handleSaveSettings = async (newSettings) => {
                try {
                    const res = await fetch(`${backendUrl}/api/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSettings),
                        credentials: 'include'
                    });
                    if (res.ok) setSettings(newSettings);
                } catch (e) { setError("Failed to save settings."); }
            };

            const handleFetchAndAnalyze = async () => {
                setIsFetching(true); setAnalysis(null); setAudioSrc(null); setError(null); setShareUrl(null);
                try {
                    const res = await fetch(`${backendUrl}/api/fetch_emails`, { credentials: 'include' });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    setAnalysis(await res.json());
                } catch (e) { setError(e.message); } 
                finally { setIsFetching(false); }
            };

            const handleGenerateAudio = async () => {
                if (!analysis) return;
                setIsGeneratingAudio(true); setError(null);
                try {
                    const res = await fetch(`${backendUrl}/api/generate_audio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysis),
                        credentials: 'include'
                    });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    setAudioSrc(`data:audio/mp3;base64,${data.audio_content}`);
                } catch (e) { setError(e.message); } 
                finally { setIsGeneratingAudio(false); }
            };

            // --- NEW: Share Handler ---
            const handleShare = async () => {
                if (!analysis) return;
                setIsSharing(true);
                try {
                    const res = await fetch(`${backendUrl}/api/share`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysis),
                        credentials: 'include'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const url = `${window.location.origin}/?share=${data.share_id}`;
                        navigator.clipboard.writeText(url);
                        setShareUrl(url);
                        setTimeout(() => setShareUrl(null), 3000); // Hide after 3s
                    }
                } catch (e) { console.error("Share error:", e); }
                finally { setIsSharing(false); }
            };
            
            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 pb-32">
                    {/* Header */}
                    <nav className="glass sticky top-0 z-40 border-b border-slate-200 dark:border-slate-800">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/20">
                                        <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                                    </div>
                                    <h1 className="text-xl font-serif font-bold text-slate-800 dark:text-white">
                                        {sharedData ? "Shared Briefing" : "My Anchor"}
                                    </h1>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                        {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                    </button>
                                    {!sharedData && (
                                        <>
                                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                                <Icons.Settings />
                                            </button>
                                            <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                                            <a href={`${backendUrl}/logout`} className="text-sm font-medium text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 px-3 py-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Logout</a>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    {!sharedData && (
                        <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} currentSettings={settings} onSave={handleSaveSettings} />
                    )}

                    <main className="py-8 px-4 sm:px-6 lg:px-8 max-w-5xl mx-auto">
                        
                        {/* Control Bar (Hidden in Shared Mode unless we add features later) */}
                        {!sharedData && (
                            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-10 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700">
                                <div>
                                    <h2 className="text-2xl font-serif font-bold text-slate-900 dark:text-white">Morning Briefing</h2>
                                    <p className="text-slate-500 dark:text-slate-400 text-sm mt-1">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                                </div>
                                <div className="flex gap-3">
                                    {/* Share Button */}
                                    {analysis && (
                                        <button 
                                            onClick={handleShare}
                                            className="p-3 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-white rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors relative"
                                            title="Share Briefing"
                                        >
                                            {shareUrl ? <Icons.Check /> : <Icons.Share />}
                                            {shareUrl && <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-100 transition-opacity">Copied!</span>}
                                        </button>
                                    )}

                                    <button onClick={handleFetchAndAnalyze} disabled={isFetching || isGeneratingAudio} className="flex items-center gap-2 px-6 py-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-white font-medium rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none disabled:opacity-50 transition-all shadow-sm">
                                        <Icons.Refresh />
                                        {isFetching ? 'Scanning...' : 'Refresh'}
                                    </button>
                                    
                                    {analysis && (
                                        <button onClick={handleGenerateAudio} disabled={isGeneratingAudio || isFetching} className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-brand-600 to-indigo-600 text-white font-bold rounded-xl hover:opacity-90 focus:outline-none disabled:opacity-50 shadow-lg shadow-brand-500/30 transition-all transform hover:scale-105">
                                            {isGeneratingAudio ? 'Synthesizing...' : <><Icons.Play /> Play Briefing</>}
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {error && <div className="mb-8 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-600 dark:text-red-400">{error}</div>}

                        {/* Content Area */}
                        {isFetching ? (
                            <LoadingState text="Scanning your inbox and analyzing key stories..." />
                        ) : analysis ? (
                            <div className="space-y-8 animate-[fadeIn_0.5s_ease-out]">
                                <div className="grid gap-8">
                                    {analysis.story_groups && analysis.story_groups.map((group, index) => (
                                        <div key={index} className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow">
                                            <div className="p-6 md:p-8">
                                                <div className="flex items-start justify-between mb-4">
                                                    <span className="px-3 py-1 bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 text-xs font-bold uppercase tracking-wider rounded-full">Top Story</span>
                                                </div>
                                                <h3 className="text-2xl md:text-3xl font-serif font-bold text-slate-900 dark:text-white mb-4 leading-tight">{group.group_headline}</h3>
                                                <p className="text-slate-600 dark:text-slate-300 text-lg leading-relaxed mb-8">{group.group_summary}</p>
                                                <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-5 border border-slate-100 dark:border-slate-800">
                                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">Source Perspectives</h4>
                                                    <div className="space-y-4">
                                                        {group.stories.map((story, i) => (
                                                            <div key={i} className="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4">
                                                                <span className="shrink-0 text-sm font-bold text-blue-700 dark:text-blue-300 px-2 py-1 bg-blue-50 dark:bg-blue-900/30 rounded-full border border-blue-100 dark:border-blue-800 shadow-sm">{story.source}</span>
                                                                <p className="text-slate-600 dark:text-slate-400 italic text-sm leading-relaxed border-l-2 border-indigo-200 dark:border-indigo-800 pl-3">"{story.angle}"</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {analysis.remaining_stories && analysis.remaining_stories.length > 0 && (
                                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 md:p-8">
                                        <h3 className="text-xl font-serif font-bold text-slate-900 dark:text-white mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">In Brief</h3>
                                        <div className="grid sm:grid-cols-2 gap-6">
                                            {analysis.remaining_stories.map((story, i) => (
                                                <div key={i} className="flex gap-3 items-start">
                                                    <span className="mt-1.5 w-1.5 h-1.5 rounded-full bg-brand-500 shrink-0"></span>
                                                    <p className="text-slate-700 dark:text-slate-300 leading-snug">{story.headline}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center py-20 opacity-50">
                                <div className="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4">
                                    <svg className="w-10 h-10 text-slate-300 dark:text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                                </div>
                                <p className="text-slate-500 dark:text-slate-400">Ready to fetch your daily briefing.</p>
                            </div>
                        )}
                    </main>

                    {/* Fixed Audio Player (Only show if not shared or if we enable audio sharing later) */}
                    {audioSrc && !sharedData && (
                        <div className="fixed bottom-0 left-0 right-0 glass border-t border-slate-200 dark:border-slate-800 p-4 shadow-2xl z-50 animate-[slideUp_0.3s_ease-out]">
                            <div className="max-w-5xl mx-auto flex items-center gap-4">
                                <div className="w-12 h-12 bg-brand-600 rounded-lg flex items-center justify-center shrink-0">
                                    <div className="w-4 h-4 bg-white rounded-full animate-pulse"></div>
                                </div>
                                <div className="flex-1">
                                    <p className="text-xs font-bold text-brand-600 dark:text-brand-400 uppercase tracking-wider mb-1">Now Playing</p>
                                    <p className="text-sm font-medium text-slate-900 dark:text-white">Your Daily AI Briefing</p>
                                </div>
                                <div className="flex-1 max-w-md">
                                    <audio controls autoPlay src={audioSrc} className="w-full h-10 accent-brand-600" />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Main App Entry ---
        const App = () => {
            const [userInfo, setUserInfo] = React.useState(null);
            const [sharedData, setSharedData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);

            React.useEffect(() => {
                const init = async () => {
                    // 1. Check for Share ID in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const shareId = urlParams.get('share');

                    if (shareId) {
                        // Load Shared View
                        try {
                            const res = await fetch(`${backendUrl}/api/shared/${shareId}`);
                            if (res.ok) setSharedData(await res.json());
                        } catch (e) { console.error("Share Fetch Error:", e); }
                        setIsLoading(false);
                    } else {
                        // 2. Normal Login Check
                        try {
                            const res = await fetch(`${backendUrl}/api/check_auth`, { credentials: 'include' });
                            const data = await res.json();
                            if (data.logged_in) setUserInfo(data.user);
                        } catch (error) { console.error("Auth Check Failed:", error); } 
                        finally { setIsLoading(false); }
                    }
                };
                init();
            }, []);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900"><p className="text-slate-500">Loading...</p></div>;
            
            // Logic: Shared View OR Logged In View OR Login Page
            if (sharedData) return <Dashboard userInfo={{name: "Guest"}} sharedData={sharedData} />;
            return userInfo ? <Dashboard userInfo={userInfo} /> : <LoginPage />;
        };
        
        const container = document.getElementById('root');
        if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>