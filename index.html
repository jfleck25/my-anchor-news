<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Anchor | Daily Briefing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4 { font-family: 'Merriweather', serif; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.7);
        }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-200">
    <div id="root"></div>

    <!-- React Dependencies (Crossorigin added for safety) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- Configuration ---
        const backendUrl = ""; 

        // --- Icons ---
        const Icons = {
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Star: ({ filled }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        };

        // --- Component: Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, currentSettings, onSave }) => {
            const [sources, setSources] = React.useState(currentSettings.sources || []);
            const [prioritySources, setPrioritySources] = React.useState(currentSettings.priority_sources || []);
            const [keywords, setKeywords] = React.useState(currentSettings.keywords || []);
            const [timeWindow, setTimeWindow] = React.useState(currentSettings.time_window_hours || 24);
            const [personality, setPersonality] = React.useState(currentSettings.personality || 'anchor');
            const [newSource, setNewSource] = React.useState("");
            const [newKeyword, setNewKeyword] = React.useState("");

            // --- Source Management ---
            const handleAddSource = () => {
                if (newSource && !sources.includes(newSource)) {
                    setSources([...sources, newSource]);
                    setNewSource("");
                }
            };
            const handleRemoveSource = (sourceToRemove) => {
                setSources(sources.filter(s => s !== sourceToRemove));
                setPrioritySources(prioritySources.filter(s => s !== sourceToRemove));
            };
            const togglePriority = (source) => {
                if (prioritySources.includes(source)) {
                    setPrioritySources(prioritySources.filter(s => s !== source));
                } else {
                    setPrioritySources([...prioritySources, source]);
                }
            };

            // --- Watchlist Management ---
            const handleAddKeyword = () => {
                if (newKeyword && !keywords.includes(newKeyword)) {
                    setKeywords([...keywords, newKeyword]);
                    setNewKeyword("");
                }
            };
            const handleRemoveKeyword = (kToRemove) => {
                setKeywords(keywords.filter(k => k !== kToRemove));
            };

            const handleKeyDown = (e, action) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    action();
                }
            };

            const handleSave = () => {
                onSave({ 
                    sources, 
                    priority_sources: prioritySources,
                    keywords,
                    time_window_hours: parseInt(timeWindow),
                    personality
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 dark:border-slate-700 transform transition-all flex flex-col max-h-[90vh]">
                        <div className="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 shrink-0">
                            <h3 className="text-lg font-semibold text-slate-800 dark:text-white font-sans">Configuration</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>

                        <div className="p-6 space-y-6 overflow-y-auto">
                            {/* Personality */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                    <Icons.Mic /> Anchor Personality
                                </label>
                                <select 
                                    value={personality} 
                                    onChange={(e) => setPersonality(e.target.value)}
                                    className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2.5"
                                >
                                    <option value="anchor">The Anchor (Professional)</option>
                                    <option value="analyst">The Analyst (Fast, Deep)</option>
                                    <option value="dj">The DJ (Casual, Fun)</option>
                                </select>
                            </div>

                            {/* Time Window */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Lookback Period</label>
                                <select 
                                    value={timeWindow} 
                                    onChange={(e) => setTimeWindow(e.target.value)}
                                    className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2.5"
                                >
                                    <option value="12">Last 12 Hours</option>
                                    <option value="24">Last 24 Hours</option>
                                    <option value="72">Last 3 Days</option>
                                    <option value="168">Last 7 Days</option>
                                </select>
                            </div>

                            {/* Watchlist */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Watchlist (Keywords)</label>
                                <p className="text-xs text-slate-500 mb-2">If added, ONLY emails containing these words will be shown.</p>
                                <div className="flex gap-2 mb-3">
                                    <input 
                                        type="text" 
                                        value={newKeyword}
                                        onChange={(e) => setNewKeyword(e.target.value)}
                                        onKeyDown={(e) => handleKeyDown(e, handleAddKeyword)} 
                                        placeholder="e.g. Apple, Interest Rates"
                                        className="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2.5"
                                    />
                                    <button onClick={handleAddKeyword} className="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white rounded-lg text-sm font-medium transition-colors">Add</button>
                                </div>
                                {keywords.length > 0 && (
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {keywords.map(k => (
                                            <span key={k} className="px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 rounded text-xs flex items-center gap-1">
                                                {k}
                                                <button onClick={() => handleRemoveKeyword(k)} className="hover:text-red-500"><svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Sources */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Sources</label>
                                <div className="flex gap-2 mb-3">
                                    <input 
                                        type="text" 
                                        value={newSource}
                                        onChange={(e) => setNewSource(e.target.value)}
                                        onKeyDown={(e) => handleKeyDown(e, handleAddSource)} 
                                        placeholder="e.g. bloomberg.com"
                                        className="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-slate-100 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block p-2.5"
                                    />
                                    <button onClick={handleAddSource} className="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium transition-colors">Add</button>
                                </div>
                                <div className="bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 p-2 max-h-40 overflow-y-auto">
                                    {sources.length === 0 ? (
                                        <p className="text-slate-400 text-sm p-2 text-center italic">No sources configured.</p>
                                    ) : (
                                        sources.map(source => {
                                            const isPriority = prioritySources.includes(source);
                                            return (
                                                <div key={source} className="flex justify-between items-center p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800 group transition-colors">
                                                    <span className="text-sm font-medium text-slate-700 dark:text-slate-300">{source}</span>
                                                    <div className="flex items-center gap-2">
                                                        <button 
                                                            onClick={() => togglePriority(source)} 
                                                            className={`p-1 rounded transition-colors ${isPriority ? 'text-yellow-500' : 'text-slate-300 hover:text-yellow-400'}`}
                                                            title={isPriority ? "Remove Priority" : "Mark as Priority"}
                                                        >
                                                            <Icons.Star filled={isPriority} />
                                                        </button>
                                                        <button onClick={() => handleRemoveSource(source)} className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                                            <Icons.Trash />
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 shrink-0">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">Cancel</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:opacity-90 rounded-lg text-sm font-medium transition-opacity shadow-lg">Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ... (Remainder of components: LoginPage, LoadingState, Dashboard, App - unchanged from last version) ...
        // Re-declaring below to ensure full file integrity
        const LoginPage = () => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-full bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none"></div>
                <div className="z-10 w-full max-w-md p-8">
                    <div className="text-center mb-10">
                        <div className="w-16 h-16 bg-brand-600 rounded-2xl mx-auto flex items-center justify-center shadow-2xl shadow-brand-500/30 mb-6 rotate-3">
                            <svg className="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                        </div>
                        <h1 className="text-4xl font-serif font-bold text-slate-900 dark:text-white mb-3">My Anchor</h1>
                        <p className="text-slate-500 dark:text-slate-400 text-lg">Your personalized AI news analyst.</p>
                    </div>
                    
                    <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700">
                        <a href={`${backendUrl}/login`} className="flex items-center justify-center w-full py-3.5 px-4 border border-slate-300 dark:border-slate-600 rounded-xl text-slate-700 dark:text-white bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-all duration-200 gap-3 font-medium">
                            <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Continue with Google
                        </a>
                        <p className="mt-6 text-center text-xs text-slate-400">By continuing, you agree to allow My Anchor to access your Gmail for analysis purposes only.</p>
                    </div>
                </div>
            </div>
        );

        const LoadingState = ({ text }) => (
            <div className="flex flex-col items-center justify-center py-20 animate-pulse">
                <div className="w-16 h-16 bg-slate-200 dark:bg-slate-700 rounded-full mb-4 relative">
                    <div className="absolute inset-0 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p className="text-slate-500 dark:text-slate-400 font-medium">{text || "Processing..."}</p>
                <div className="mt-8 space-y-4 w-full max-w-lg">
                    <div className="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mx-auto"></div>
                    <div className="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mx-auto"></div>
                </div>
            </div>
        );

        const Dashboard = ({ userInfo, sharedData }) => {
            const [analysis, setAnalysis] = React.useState(sharedData || null);
            const [audioSrc, setAudioSrc] = React.useState(null);
            const [isFetching, setIsFetching] = React.useState(false);
            const [isGeneratingAudio, setIsGeneratingAudio] = React.useState(false);
            const [isSharing, setIsSharing] = React.useState(false);
            const [shareUrl, setShareUrl] = React.useState(null);
            const [copySuccess, setCopySuccess] = React.useState(false);
            const [playbackRate, setPlaybackRate] = React.useState(1.0);
            const [error, setError] = React.useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);
            const [settings, setSettings] = React.useState({});
            const [darkMode, setDarkMode] = React.useState(false);

            const audioRef = React.useRef(null);

            React.useEffect(() => {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) setDarkMode(true);
            }, []);

            React.useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            React.useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.playbackRate = playbackRate;
                }
            }, [audioSrc, playbackRate]);

            React.useEffect(() => {
                if (!sharedData) { 
                    const fetchSettings = async () => {
                        try {
                            const res = await fetch(`${backendUrl}/api/settings`, { credentials: 'include' });
                            if (res.ok) setSettings(await res.json());
                        } catch (e) { console.error("Settings fetch error:", e); }
                    };
                    fetchSettings();
                }
            }, [sharedData]);

            const handleSaveSettings = async (newSettings) => {
                try {
                    const res = await fetch(`${backendUrl}/api/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSettings),
                        credentials: 'include'
                    });
                    if (res.ok) setSettings(newSettings);
                } catch (e) { setError("Failed to save settings."); }
            };

            const handleFetchAndAnalyze = async () => {
                setIsFetching(true); setAnalysis(null); setAudioSrc(null); setError(null); setShareUrl(null);
                try {
                    const res = await fetch(`${backendUrl}/api/fetch_emails`, { credentials: 'include' });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    setAnalysis(await res.json());
                } catch (e) { setError(e.message); } 
                finally { setIsFetching(false); }
            };

            const handleGenerateAudio = async () => {
                if (!analysis) return;
                setIsGeneratingAudio(true); setError(null);
                try {
                    const res = await fetch(`${backendUrl}/api/generate_audio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysis),
                        credentials: 'include'
                    });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    setAudioSrc(`data:audio/mp3;base64,${data.audio_content}`);
                } catch (e) { setError(e.message); } 
                finally { setIsGeneratingAudio(false); }
            };

            const handleShare = async () => {
                if (!analysis) return;
                setIsSharing(true);
                try {
                    const res = await fetch(`${backendUrl}/api/share`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysis),
                        credentials: 'include'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const url = `${window.location.origin}/?share=${data.share_id}`;
                        navigator.clipboard.writeText(url);
                        setShareUrl(url);
                        setTimeout(() => setShareUrl(null), 3000); 
                    }
                } catch (e) { console.error("Share error:", e); }
                finally { setIsSharing(false); }
            };

            const handleCopySummary = () => {
                if (!analysis) return;
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                let text = `Morning Briefing - ${today}\n\n`;
                if (analysis.story_groups) {
                    analysis.story_groups.forEach(group => {
                        text += `**${group.group_headline}**\n${group.group_summary}\n`;
                        if (group.stories) {
                            group.stories.forEach(story => {
                                text += `* [${story.source}]: ${story.angle}\n`;
                            });
                        }
                        text += `\n`;
                    });
                }
                if (analysis.remaining_stories && analysis.remaining_stories.length > 0) {
                    text += `**In Brief:**\n`;
                    analysis.remaining_stories.forEach(story => {
                        text += `* ${story.headline}\n`;
                    });
                }
                navigator.clipboard.writeText(text).then(() => {
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 3000);
                });
            };

            const handleToggleSpeed = () => {
                const speeds = [1.0, 1.25, 1.5, 2.0];
                const currentIndex = speeds.indexOf(playbackRate);
                const nextSpeed = speeds[(currentIndex + 1) % speeds.length];
                setPlaybackRate(nextSpeed);
            };
            
            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 pb-32">
                    <nav className="glass sticky top-0 z-40 border-b border-slate-200 dark:border-slate-800">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/20">
                                        <svg className="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                                    </div>
                                    <h1 className="text-xl font-serif font-bold text-slate-800 dark:text-white">
                                        {sharedData ? "Shared Briefing" : "My Anchor"}
                                    </h1>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                        {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                    </button>
                                    {!sharedData && (
                                        <>
                                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                                <Icons.Settings />
                                            </button>
                                            <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                                            <a href={`${backendUrl}/logout`} className="text-sm font-medium text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 px-3 py-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Logout</a>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    {!sharedData && isSettingsOpen && (
                        <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} currentSettings={settings} onSave={handleSaveSettings} />
                    )}

                    <main className="py-8 px-4 sm:px-6 lg:px-8 max-w-5xl mx-auto">
                        {!sharedData && (
                            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-10 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700">
                                <div>
                                    <div className="flex items-center gap-3 mb-1">
                                        <h2 className="text-2xl font-serif font-bold text-slate-900 dark:text-white">Morning Briefing</h2>
                                    </div>
                                    <p className="text-slate-500 dark:text-slate-400 text-sm">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                                </div>
                                <div className="flex gap-3">
                                    {analysis && (
                                        <button onClick={handleCopySummary} className="p-3 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-white rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors relative" title="Copy Executive Summary">
                                            {copySuccess ? <Icons.Check /> : <Icons.Copy />}
                                            {copySuccess && <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-100 transition-opacity whitespace-nowrap">Copied Text!</span>}
                                        </button>
                                    )}
                                    {analysis && (
                                        <button onClick={handleShare} className="p-3 text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-white rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors relative" title="Share Briefing Link">
                                            {shareUrl ? <Icons.Check /> : <Icons.Share />}
                                            {shareUrl && <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-100 transition-opacity">Copied Link!</span>}
                                        </button>
                                    )}
                                    <button onClick={handleFetchAndAnalyze} disabled={isFetching || isGeneratingAudio} className="flex items-center gap-2 px-6 py-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-white font-medium rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none disabled:opacity-50 transition-all shadow-sm">
                                        <Icons.Refresh />
                                        {isFetching ? 'Scanning...' : 'Refresh'}
                                    </button>
                                    {analysis && (
                                        <button onClick={handleGenerateAudio} disabled={isGeneratingAudio || isFetching} className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-brand-600 to-indigo-600 text-white font-bold rounded-xl hover:opacity-90 focus:outline-none disabled:opacity-50 shadow-lg shadow-brand-500/30 transition-all transform hover:scale-105">
                                            {isGeneratingAudio ? 'Synthesizing...' : <><Icons.Play /> Play Briefing</>}
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}

                        {error && <div className="mb-8 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-600 dark:text-red-400">{error}</div>}

                        {isFetching ? (
                            <LoadingState text="Scanning your inbox and analyzing key stories..." />
                        ) : analysis ? (
                            <div className="space-y-8 animate-[fadeIn_0.5s_ease-out]">
                                <div className="grid gap-8">
                                    {analysis.story_groups && analysis.story_groups.map((group, index) => (
                                        <div key={index} className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow">
                                            <div className="p-6 md:p-8">
                                                <div className="flex items-start justify-between mb-4">
                                                    <span className="px-3 py-1 bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 text-xs font-bold uppercase tracking-wider rounded-full">Top Story</span>
                                                </div>
                                                <h3 className="text-2xl md:text-3xl font-serif font-bold text-slate-900 dark:text-white mb-4 leading-tight">{group.group_headline}</h3>
                                                <p className="text-slate-600 dark:text-slate-300 text-lg leading-relaxed mb-8">{group.group_summary}</p>
                                                <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-5 border border-slate-100 dark:border-slate-800">
                                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">Source Perspectives</h4>
                                                    <div className="space-y-4">
                                                        {group.stories.map((story, i) => (
                                                            <div key={i} className="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4">
                                                                <span className="shrink-0 text-sm font-bold text-blue-700 dark:text-blue-300 px-2 py-1 bg-blue-50 dark:bg-blue-900/30 rounded-full border border-blue-100 dark:border-blue-800 shadow-sm">{story.source}</span>
                                                                <p className="text-slate-600 dark:text-slate-400 italic text-sm leading-relaxed border-l-2 border-indigo-200 dark:border-indigo-800 pl-3">"{story.angle}"</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {analysis.remaining_stories && analysis.remaining_stories.length > 0 && (
                                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 md:p-8">
                                        <h3 className="text-xl font-serif font-bold text-slate-900 dark:text-white mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">In Brief</h3>
                                        <div className="grid sm:grid-cols-2 gap-6">
                                            {analysis.remaining_stories.map((story, i) => (
                                                <div key={i} className="flex gap-3 items-start">
                                                    <span className="mt-1.5 w-1.5 h-1.5 rounded-full bg-brand-500 shrink-0"></span>
                                                    <p className="text-slate-700 dark:text-slate-300 leading-snug">{story.headline}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center py-20 opacity-50">
                                <div className="w-24 h-24 bg-slate-100 dark:bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4">
                                    <svg className="w-10 h-10 text-slate-300 dark:text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                                </div>
                                <p className="text-slate-500 dark:text-slate-400">Ready to fetch your daily briefing.</p>
                            </div>
                        )}
                    </main>

                    {audioSrc && !sharedData && (
                        <div className="fixed bottom-0 left-0 right-0 glass border-t border-slate-200 dark:border-slate-800 p-4 shadow-2xl z-50 animate-[slideUp_0.3s_ease-out]">
                            <div className="max-w-5xl mx-auto flex items-center gap-4">
                                <div className="w-12 h-12 bg-brand-600 rounded-lg flex items-center justify-center shrink-0">
                                    <div className="w-4 h-4 bg-white rounded-full animate-pulse"></div>
                                </div>
                                <div className="flex-1">
                                    <p className="text-xs font-bold text-brand-600 dark:text-brand-400 uppercase tracking-wider mb-1">Now Playing</p>
                                    <p className="text-sm font-medium text-slate-900 dark:text-white">Your Daily AI Briefing</p>
                                </div>
                                <button onClick={handleToggleSpeed} className="px-3 py-1 text-xs font-bold text-slate-600 dark:text-slate-300 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                                    {playbackRate.toFixed(2)}x
                                </button>
                                <div className="flex-1 max-w-md">
                                    <audio ref={audioRef} controls autoPlay src={audioSrc} className="w-full h-10 accent-brand-600" />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const container = document.getElementById('root');
        if (container) { const root = ReactDOM.createRoot(container); root.render(<App />); }
    </script>
</body>
</html>