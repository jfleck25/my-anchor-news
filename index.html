<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Synthesis App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const backendUrl = "";

        // --- Component: Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, currentSettings, onSave }) => {
            if (!isOpen) return null;

            const [sources, setSources] = React.useState(currentSettings.sources || []);
            const [timeWindow, setTimeWindow] = React.useState(currentSettings.time_window_hours || 24);
            const [newSource, setNewSource] = React.useState("");

            const handleAddSource = () => {
                if (newSource && !sources.includes(newSource)) {
                    setSources([...sources, newSource]);
                    setNewSource("");
                }
            };

            const handleRemoveSource = (sourceToRemove) => {
                setSources(sources.filter(s => s !== sourceToRemove));
            };

            const handleSave = () => {
                onSave({ sources, time_window_hours: parseInt(timeWindow) });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-900">Settings</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>

                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2">Time Window</label>
                            <select 
                                value={timeWindow} 
                                onChange={(e) => setTimeWindow(e.target.value)}
                                className="block w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded focus:outline-none focus:border-indigo-500"
                            >
                                <option value="12">Last 12 Hours</option>
                                <option value="24">Last 24 Hours</option>
                                <option value="72">Last 3 Days</option>
                                <option value="168">Last 7 Days</option>
                            </select>
                        </div>

                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2">Newsletter Sources</label>
                            <div className="flex mb-2">
                                <input 
                                    type="text" 
                                    value={newSource}
                                    onChange={(e) => setNewSource(e.target.value)}
                                    placeholder="e.g. theverge.com"
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mr-2"
                                />
                                <button onClick={handleAddSource} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none">Add</button>
                            </div>
                            <div className="bg-gray-50 rounded border p-2 h-40 overflow-y-auto">
                                {sources.length === 0 ? (
                                    <p className="text-gray-500 text-sm p-2">No sources added.</p>
                                ) : (
                                    sources.map(source => (
                                        <div key={source} className="flex justify-between items-center p-2 border-b last:border-0 hover:bg-gray-100">
                                            <span className="text-sm text-gray-700">{source}</span>
                                            <button onClick={() => handleRemoveSource(source)} className="text-red-500 hover:text-red-700 text-sm">Remove</button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none">Cancel</button>
                            <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none">Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Component: Login Page ---
        const LoginPage = () => (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                <div className="max-w-md w-full space-y-8 text-center">
                    <div>
                        <svg className="mx-auto h-12 w-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6m-1 8h.01" /></svg>
                        <h2 className="mt-6 text-3xl font-extrabold text-gray-900">Your Morning News, Synthesized</h2>
                        <p className="mt-2 text-sm text-gray-600">Connect your Google account to automatically fetch and analyze your daily newsletters.</p>
                    </div>
                    <div className="mt-8">
                        <a href={`${backendUrl}/login`} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none shadow-lg transition-transform transform hover:scale-105">
                            <span className="absolute left-0 inset-y-0 flex items-center pl-3"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" className="bi bi-google" viewBox="0 0 16 16"><path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.25C2.806 7.655 2.5 8.522 2.5 9.42c0 .897.306 1.765.858 2.499.632 1.84 2.405 3.25 4.492 3.25 1.257 0 2.34-.47 3.162-1.2l2.284 2.284A7.96 7.96 0 0 1 8 16Z"/></svg></span>
                            Connect Your Google Account
                        </a>
                    </div>
                </div>
            </div>
        );

        // --- Component: Dashboard ---
        const Dashboard = ({ userInfo }) => {
            const [analysis, setAnalysis] = React.useState(null);
            const [audioSrc, setAudioSrc] = React.useState(null);
            const [isFetching, setIsFetching] = React.useState(false);
            const [isGeneratingAudio, setIsGeneratingAudio] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);
            const [settings, setSettings] = React.useState({});

            React.useEffect(() => {
                const fetchSettings = async () => {
                    try {
                        const res = await fetch(`${backendUrl}/api/settings`, { credentials: 'include' });
                        if (res.ok) setSettings(await res.json());
                    } catch (e) { console.error("Settings fetch error:", e); }
                };
                fetchSettings();
            }, []);

            const handleSaveSettings = async (newSettings) => {
                try {
                    const res = await fetch(`${backendUrl}/api/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSettings),
                        credentials: 'include'
                    });
                    if (res.ok) setSettings(newSettings);
                } catch (e) { setError("Failed to save settings."); }
            };

            const handleFetchAndAnalyze = async () => {
                setIsFetching(true);
                setAnalysis(null);
                setAudioSrc(null);
                setError(null);
                try {
                    const res = await fetch(`${backendUrl}/api/fetch_emails`, { credentials: 'include' });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    setAnalysis(await res.json());
                } catch (e) { setError(e.message); } 
                finally { setIsFetching(false); }
            };

            const handleGenerateAudio = async () => {
                if (!analysis) return;
                setIsGeneratingAudio(true);
                setError(null);
                try {
                    const res = await fetch(`${backendUrl}/api/generate_audio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysis),
                        credentials: 'include'
                    });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    setAudioSrc(`data:audio/mp3;base64,${data.audio_content}`);
                } catch (e) { setError(e.message); } 
                finally { setIsGeneratingAudio(false); }
            };
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <nav className="bg-white shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center"><h1 className="text-xl font-bold text-indigo-600">MyAnchor</h1></div>
                                <div className="flex items-center">
                                    <p className="text-sm text-gray-600 mr-4">Welcome, {userInfo.name}!</p>
                                    <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-gray-500 hover:text-indigo-600 mr-2 rounded-full hover:bg-gray-100" title="Settings">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    </button>
                                    <a href={`${backendUrl}/logout`} className="text-sm font-medium text-gray-500 hover:text-gray-700">Logout</a>
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        currentSettings={settings}
                        onSave={handleSaveSettings}
                    />

                    <main className="py-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="bg-white p-8 rounded-lg shadow">
                                <div className="flex items-center justify-between mb-6">
                                    <h2 className="text-2xl font-bold">Your Newsletter Briefing</h2>
                                    {analysis && !audioSrc && (
                                        <button onClick={handleGenerateAudio} disabled={isGeneratingAudio} className="px-5 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400">
                                            {isGeneratingAudio ? 'Generating Audio...' : 'Play Briefing'}
                                        </button>
                                    )}
                                </div>
                                
                                {audioSrc && (
                                    <div className="mb-6">
                                        <audio controls autoPlay src={audioSrc} className="w-full">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                )}

                                <button onClick={handleFetchAndAnalyze} disabled={isFetching} className="px-6 py-3 mb-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none disabled:bg-gray-400">
                                    {isFetching ? 'Analyzing...' : 'Fetch & Analyze Newsletters'}
                                </button>
                                {error && <p className="text-red-500 mt-2">Error: {error}</p>}
                                
                                {analysis && (
                                    <div className="space-y-8 mt-6">
                                        {analysis.story_groups && analysis.story_groups.map((group, index) => (
                                            <div key={index} className="p-6 border-2 border-indigo-100 rounded-lg bg-white shadow-sm">
                                                <h3 className="font-bold text-2xl text-indigo-900 mb-3">{group.group_headline}</h3>
                                                <p className="text-gray-800 mb-6 text-lg leading-relaxed">{group.group_summary}</p>
                                                <div className="space-y-4">
                                                    <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wider border-b pb-2">Unique Perspectives</h4>
                                                    {group.stories.map((story, i) => (
                                                        <div key={i} className="pl-4 border-l-4 border-purple-400 bg-purple-50 p-3 rounded-r-md">
                                                            <p className="text-sm font-bold text-purple-900 mb-1">{story.source}</p>
                                                            <p className="text-gray-800 italic">"{story.angle}"</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                        {analysis.remaining_stories && analysis.remaining_stories.length > 0 && (
                                            <div className="p-4 border-2 border-gray-200 rounded-lg bg-gray-50">
                                                <h3 className="font-bold text-lg text-gray-800 mb-4">In Brief</h3>
                                                <ul className="list-disc list-inside space-y-2">
                                                    {analysis.remaining_stories.map((story, i) => (
                                                        <li key={i} className="text-gray-700">{story.headline}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // --- Main App Entry ---
        const App = () => {
            const [userInfo, setUserInfo] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);

            React.useEffect(() => {
                const checkUserAuth = async () => {
                    try {
                        const res = await fetch(`${backendUrl}/api/check_auth`, { credentials: 'include' });
                        // --- FIX: Changed 'response.json()' to 'res.json()' ---
                        const data = await res.json(); 
                        if (data.logged_in) setUserInfo(data.user);
                    } catch (error) { console.error("Auth Check Failed:", error); } 
                    finally { setIsLoading(false); }
                };
                checkUserAuth();
            }, []);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center"><p>Loading...</p></div>;
            return userInfo ? <Dashboard userInfo={userInfo} /> : <LoginPage />;
        };
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>